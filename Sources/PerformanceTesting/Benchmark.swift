//
//  Benchmark.swift
//  PerformanceTesting
//
//  Created by James Bean on 8/11/17.
//

import Foundation

public struct Benchmark <Subject> {

    // MARK: - Type Methods

    /// - Returns: A `Benchmark` for an `operation` which mutates a `Subject` generated by `setup`.
    /// This operation will be measured `trialCount` times at each of the sizes in `testPoints`.
    public static func mutating <Subject> (
        trialCount: Int = 10,
        testPoints: [Int] = Scale.medium,
        setup: @escaping (Int) -> Subject,
        measuring operation: @escaping (inout Subject) -> Void
    ) -> Benchmark
    {
        var points: [TestPoint] = []
        for size in testPoints {
            var trials: [Double] = []
            for _ in 0..<trialCount {
                var subject = setup(size)
                let time = measure { operation(&subject) }
                trials.append(time)
            }
            points.append(TestPoint(size: size, trials: trials))
        }
        return Benchmark(testPoints: points)
    }

    /// - Returns: A `Benchmark` for an `operation` which acts on a `Subject` generated by `setup`.
    /// This operation will be measured `trialCount` times at each of the sizes in `testPoints`.
    public static func nonMutating <Subject> (
        trialCount: Int = 10,
        testPoints: [Int] = Scale.medium,
        setup: @escaping (Int) -> Subject,
        measuring operation: @escaping (Subject) -> Void
    ) -> Benchmark
    {
        return Benchmark(
            testPoints: testPoints.map { size in
                let subject = setup(size)
                return TestPoint(
                    size: size,
                    trials: (0..<trialCount).map { _ in measure { operation(subject) } }
                )
            }
        )
    }

    // MARK: - Instance Properties

    /// - Returns: The average measure time to perform an operation, indexed by the size of the
    /// domain.
    var data: [(x: Double, y: Double)] {
        return testPoints.map { (x: Double($0.size), y: $0.trials.average) }
    }

    let testPoints: [TestPoint]

    // MARK: - Initializers

    init(testPoints: [TestPoint]) {
        self.testPoints = testPoints
    }
}

/// - Returns: The amount of time that it takes to perform the given `operation`.
private func measure (operation: () -> Void) -> Double {
    let start = CFAbsoluteTimeGetCurrent()
    operation()
    let finish = CFAbsoluteTimeGetCurrent()
    return finish - start
}
